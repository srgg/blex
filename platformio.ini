; PlatformIO Project Configuration File for srgg/blex library
;

[platformio]
default_envs = basic_server

[dfu_upload]
upload_protocol = custom
upload_speed = -1
extra_scripts =
upload_command = ~/.platformio/penv/bin/python -u $PROJECT_DIR/scripts/dfu-ble-uploader.py $SOURCE

[esptool_upload]
upload_protocol = esptool
upload_speed = 921600
extra_scripts =
upload_command =

[upload]
extends = esptool_upload
;extends = dfu_upload

; ===================== Common Settings (All Environments) =====================
[env]
upload = ${serial_upload}

upload_protocol = ${upload.upload_protocol}
upload_speed = ${upload.upload_speed}
upload_command = ${upload.upload_command}

build_src_filter =
    +<*>
    -<examples/>

; To check supported C++ features use:  ~/.platformio/packages/toolchain-xtensa-esp32s3/bin/xtensa-esp32s3-elf-g++ -std=c++2a -dM -E - < /dev/null
extra_scripts =
    pre:scripts/version.py          ; Automated versioning from Git
    pre:scripts/cpp-build-flags.py  ; Enforce specific C++ build flags

platform = espressif32@6.10.0
board = um_feathers3
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
framework = arduino

; NOTE: C/C++2a standard (-std=gnu++2a) is set via cpp-build-flags.py
build_flags =
    -DPLATFORMIO_BUILD
    -DBLEX_LOG_LEVEL_TRACE

    ; ==================== Suppress Third-Party Library Warnings ====================
    -Wno-attributes              ; Suppress conflicting IRAM section warnings (xPortCanYield, xPortGetCoreID)
    -Wno-unused-parameter        ; Embedded code often has unused params (callbacks)
    -Wno-psabi                   ; Suppress ABI compatibility warnings (cross-compilation)
    -Wno-pedantic                ; Suppress pedantic warnings from Arduino/ESP-IDF (anonymous structs)
    -Wno-variadic-macros         ; Suppress variadic macro warnings from NimBLE

    ; Fix RWX segments with proper ESP32-S3 cache sizes
    -Wl,-z,separate-code
    -Wl,--gc-sections

    ; Places literal pools (constants) next to the code that uses them
    ; rather than in a separate section. This improves performance.
    -mtext-section-literals

build_unflags =
    -std=gnu++11           ; DO NOT USE C++11 (C++20 set via cpp-build-flags.py)
    -flto                  ; REMOVED: Link-time optimization - not compatible with toolchain
    -fprefetch-loop-arrays ; REMOVED: Unsupported by target architecture â€“ causes compiler warning

; Serial monitor settings
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Library dependencies (pinned to exact versions for production stability)
lib_deps =
    https://github.com/srgg/NimBLE-Arduino.git#feat/aggregate-format-2905

; =================== Environment-Specific Settings ===================
; This environments inherit all settings from [env]

[env:simple_server]
build_src_filter =
    +<../examples/simple_server/>

[env:basic_server]
build_src_filter =
    +<../examples/basic_server/>

[env:imu_streamer]
build_src_filter =
    ${env.build_src_filter}
    +<../examples/imu_streamer/>

lib_deps =
    ${env.lib_deps}
    adafruit/Adafruit Sensor Lab@^0.8.3

build_flags =
    ${env.build_flags}