; PlatformIO Project Configuration File for srgg/blex library
;

[platformio]
default_envs = basic_server

[dfu_upload]
upload_protocol = custom
upload_speed = -1
extra_scripts =
upload_command = ~/.platformio/penv/bin/python -u $PROJECT_DIR/scripts/dfu-ble-uploader.py $SOURCE -d 'BLIM IMU Stream'

[esptool_upload]
upload_protocol = esptool
upload_speed = 921600
extra_scripts =
upload_command =

[upload]
extends = esptool_upload
;extends = dfu_upload

; ===================== Common Settings (All Environments) =====================
[env]
upload = ${serial_upload}

upload_protocol = ${upload.upload_protocol}
upload_speed = ${upload.upload_speed}
upload_command = ${upload.upload_command}

; To check supported C++ features use:  ~/.platformio/packages/toolchain-xtensa-esp32s3/bin/xtensa-esp32s3-elf-g++ -std=c++2a -dM -E - < /dev/null
extra_scripts =
    pre:scripts/version.py          ; Automated versioning from Git
    pre:scripts/cpp-build-flags.py  ; C++-only compiler flags (avoids warnings on C files)

platform = espressif32@6.10.0
board = um_feathers3
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
framework = arduino

; Build flags (applied to both C and C++ files)
build_flags =
    -DPLATFORMIO_BUILD
    -std=gnu++2a
    ; Suppress conflicting IRAM section warnings (xPortCanYield, xPortGetCoreID functions)
    -Wno-attributes

    ; Fix RWX segments with proper ESP32-S3 cache sizes
    -Wl,-z,separate-code
    -Wl,--gc-sections

    ; Places literal pools (constants) next to the code that uses them
    ; rather than in a separate section. This improves performance.
    -mtext-section-literals

    ; Board configuration
    -DCORE_DEBUG_LEVEL=5
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_RUNNING_CORE=1

    ; NimBLE stack configuration - increase stack sizes to prevent overflow
    -DCONFIG_BT_NIMBLE_HOST_TASK_STACK_SIZE=16384   ; Default 4096, increased for callbacks with logging
    -DCONFIG_BT_NIMBLE_ACL_BUF_SIZE=512             ; Default 255 (matches MTU 247 + header)
    -DCONFIG_BT_NIMBLE_ACL_BUF_COUNT=12             ; Default 12

    ; NimBLE logging (verbose)
    -DCONFIG_NIMBLE_CPP_LOG_LEVEL=5                 ; 5=VERBOSE, 4=DEBUG, 3=INFO
    -DCONFIG_BT_NIMBLE_LOG_LEVEL=5
    -DBLIM_LOG_LEVEL=BLIM_LOG_LEVEL_TRACE
;    -DBLIM_LOG_LEVEL=BLIM_LOG_LEVEL_DEBUG

build_unflags =
    -std=gnu++11           ; DO NOT USE C++11 (C++20 set via cpp-build-flags.py)
    -flto                  ; REMOVED: Link-time optimization - not compatible with toolchain
    -fprefetch-loop-arrays ; REMOVED: Unsupported by target architecture â€“ causes compiler warning

; Serial monitor settings
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Library dependencies (pinned to exact versions for production stability)
lib_deps =
;    adafruit/Adafruit LSM6DS@4.7.0
;    adafruit/Adafruit LIS3MDL@1.2.4
;    adafruit/Adafruit Unified Sensor@1.1.14
;    bblanchon/ArduinoJson@7.2.0
    https://github.com/srgg/NimBLE-Arduino.git#feat/aggregate-format-2905

; =================== Environment-Specific Settings ===================
[env:basic_server]
build_src_filter =
    +<*>
    -<examples/>
    +<../examples/basic_server/>

;[env:um_feathers3]
; This environment inherits all settings from [env]
; Add environment-specific overrides here if needed